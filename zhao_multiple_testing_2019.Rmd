---
title: "Multiple Testing When Many p-Values are Uniformly Conservative"
subtitle: "Multiple Comparisons and Selective Inference Sem. A 2020"
author: "Giora Simchoni"
institute: "Stat. and OR Department, TAU"
date: "`r Sys.Date()`"
output_dir: "images"
output:
  xaringan::moon_reader:
    css: "slides.css"
    seal: false
    includes:
      in_header: "header.html"
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

---

class: title-slide

## Multiple Testing When Many P-Values are Uniformly Conservative

#### Qingyuan Zhao, Dylan S. Small, and Weijie Su (2019)

##### Presented by: Giora Simchoni

### Multiple Comparisons and Selective Inference Sem. A 2020

#### Stat. and OR Department, TAU
#### 2020-11-05

---
```{r child = "setup.Rmd"}
```

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
```

class: section-slide

# At Highest Level

---

## There's a Story

.no_shadow[
<center><img src = "images/high_level_story.png" style="width: 100%"></center>
]

---

class: section-slide

# Motivation

---

### Educational Intervention

[Cooper et al. (2003)](https://www.jstor.org/stable/3516042) Meta-Analysis:

<center><img src = "images/cooper_abstract.png" style="width: 70%"></center>

---

### A typical (over-simplified) Mixed Model

$$y_i = \beta_0 + \beta_MX_i + b_S + \epsilon_i$$

Where:

$$y_i = \text{Student i "achievement"}$$

$$X_i = \begin{cases}
      0, & \text{Student i in Modified Calendar}\ \\
      1, & \text{Otherwise}
    \end{cases}$$

$$b_S \sim N(0, \sigma_S^2) \text{ (Random Effect of Study S)}$$

$$\epsilon_i \sim N(0, \sigma_E^2)$$

And we're interested in:

$$H_0: \beta_M \leq 0 \space vs. \space H_1: \beta_M > 0$$

---

### Result: "quite small"

<center><img src = "images/cooper_results.png" style="width: 45%"></center>

---

### But could there be a (qualitative) interaction?

.pull-left[

#### Quantitative (Ordinal) Interaction

```{r Ordinal-Interaction, echo=FALSE, out.width="100%"}
tibble(X = factor(c(0, 0, 1, 1)),
       Group = factor(c("A", "B", "A", "B")),
       y = c(5, 6, 6, 12)) %>%
  ggplot(aes(X, y, color = Group, group = Group)) +
  geom_line(lwd = 2) +
  geom_point(size = 8) +
  theme_light() +
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 24),
        axis.title.y = element_text(size = 24),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))
```

]

.pull-right[

#### Qualitative (Disordinal) Interaction

```{r Disrdinal-Interaction, echo=FALSE, out.width="100%"}
tibble(X = factor(c(0, 0, 1, 1)),
       Group = factor(c("A", "B", "A", "B")),
       y = c(9, 6, 7, 12)) %>%
  ggplot(aes(X, y, color = Group, group = Group)) +
  geom_line(lwd = 2) +
  geom_point(size = 8) +
  theme_light() +
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 24),
        axis.title.y = element_text(size = 24),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))
```

]

---

#### Why is the ME model unsuitable for testing qualitative interaction?

- $\sigma_S > 0$ significantly, was found. What does that mean?
- So, go to a Fixed Effects model and make school/district a categorical variable with ~50 levels?...
- Can the ME model incorporate interaction? Can't guess apriori (and therefore put in the model) which groups (schools, districts) belong to positive/negative treatment effect

---

class: section-slide

# Multiple Testing Problem

---

### Qualitative Interaction is MTP

- $n$ subgroups or independent studies
- $b_{S_i} \sim N(\mu_i, \sigma_i^2)$
- Single study "positive" null: $H^+_{0i} = \{\mu_i \ge 0\}$
- Global "positive" null: $H_0^+ = \cap_{i=1}^n H^+_{0i} = \{\mu_i \ge 0, \forall i\}$
- Global "negative" null: $H_0^- = \cap_{i=1}^n H^-_{0i} = \{\mu_i \le 0, \forall i\}$

 $\implies$ Null hypothesis of NO qualitative interaction:
 $$H_0 = H_0^+ \cup H_0^-$$
 
Reject $H_0$ if both $H_0^+$ and $H_0^-$ are rejected at level $\alpha$.

---

### So we're good?

- Forget the ME model
- Test each study $i$ separately, get a P-Value $p_i$
- Input $p_1, ..., p_n$ into your favorite MTP handler: Bonferroni, Fisher, BH, ...
- Done.

---

### The Problems of Conservative Tests

- Suppose $Y_1, ..., Y_{100}$ are $N(\mu_i, 1)$ RVs
- Global null: $H_0 = \cap_{i=1}^n H_{0i} = \{\mu_i \le 0, \forall i\}$
- Observe $y_1, ..., y_n$
- P-Value would be: $p_i = P_{H_{0i}}(Y_i > y_i) = 1 - \phi(y_i)$
- Calculate $p_1, ..., p_n$
- If in reality $\{\mu_i = 0, \forall i\} \implies p_i \sim U(0, 1)$
- If in reality e.g. $\{\mu_i = -1, \forall i\} \implies p_i \succ U(0, 1)$
- a.k.a P-Values have stochastically larger distribution than $U(0, 1)$
- a.k.a P-Values are conservative

---

### How does conservative look like?

```{r Conservative-P-Values}
y1 <- rnorm(n = 100, mean = 0)
p1 <- 1 - pnorm(y1, mean = 0)
y2 <- rnorm(n = 100, mean = -1)
p2 <- 1 - pnorm(y2, mean = 0)

```

```{r echo=FALSE}
df <- tibble(p_val = c(p1, p2),
             mu = factor(c(rep(0, 100), rep(-1, 100))))
h <- df %>%
  ggplot(aes(p_val, fill = mu)) +
  geom_histogram(bins = 20, alpha = 0.5)

cdf <- df %>%
  ggplot(aes(p_val, color = mu)) +
  stat_ecdf()
```

.pull-left[
```{r Conservative-Hists, echo=FALSE, out.width="100%"}
h +
  labs(y = NULL) +
  theme_light() +
  theme(axis.text = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))
```
]

.pull-right[
```{r Conservative-CDFs, echo=FALSE, out.width="100%"}
cdf +
  labs(y = "F(p_val)") +
  theme_light() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))
```
]